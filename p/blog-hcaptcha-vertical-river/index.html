<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>"Please click each image containing a vertical river" | 小冰爱吃盐</title>
<meta name=keywords content="hCaptcha,,hCaptcha,Solver"><meta name=description content="关于 Please click each image containing a vertical river 的 hCaptcha 解决方案"><meta name=author content="北屿"><link rel=canonical href=https://blog.bj-yan.top/p/blog-hcaptcha-vertical-river/><meta name=google-site-verification content="G-PRK0FMMDH1"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.8d0a354998e71ab0f222ae59ef33b3acb610ae9b11671c8d8c5ab4a9bfbe09b7.css integrity="sha256-jQo1SZjnGrDyIq5Z7zOzrLYQrpsRZxyNjFq0qb++Cbc=" rel="preload stylesheet" as=style><link rel=preload href=/favicon.jpg as=image><link rel=icon href=https://blog.bj-yan.top/favicon.jpg><link rel=icon type=image/png sizes=16x16 href=https://blog.bj-yan.top/favicon.jpg><link rel=icon type=image/png sizes=32x32 href=https://blog.bj-yan.top/favicon.jpg><link rel=apple-touch-icon href=https://blog.bj-yan.top/favicon.jpg><link rel=mask-icon href=https://blog.bj-yan.top/favicon.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.136.5"><link rel=alternate hreflang=zh-cn href=https://blog.bj-yan.top/p/blog-hcaptcha-vertical-river/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?d396c00ca4fe6547a19249d34cb91254",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script type=text/javascript async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><link href=//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=G-DC28LRQ4E5"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-DC28LRQ4E5")}</script><meta property="og:title" content='"Please click each image containing a vertical river"'><meta property="og:description" content="关于 Please click each image containing a vertical river 的 hCaptcha 解决方案"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.bj-yan.top/p/blog-hcaptcha-vertical-river/"><meta property="og:image" content="https://blog.bj-yan.top/favicon.jpg"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-03-02T10:32:15+08:00"><meta property="article:modified_time" content="2023-03-21T12:52:17+08:00"><meta property="og:site_name" content="小冰爱吃盐"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.bj-yan.top/favicon.jpg"><meta name=twitter:title content='"Please click each image containing a vertical river"'><meta name=twitter:description content="关于 Please click each image containing a vertical river 的 hCaptcha 解决方案"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.bj-yan.top/post/"},{"@type":"ListItem","position":2,"name":"\"Please click each image containing a vertical river\"","item":"https://blog.bj-yan.top/p/blog-hcaptcha-vertical-river/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"\"Please click each image containing a vertical river\"","name":"\u0022Please click each image containing a vertical river\u0022","description":"关于 Please click each image containing a vertical river 的 hCaptcha 解决方案","keywords":["hCaptcha,","hCaptcha","Solver"],"articleBody":" 引言 最近 hCaptcha 迎来了一次更新，从之前的物体识别，改成了选出图片中的垂直河流。如上图，截自https://www.hcaptcha.com/。\n说实话，第一看看到就知道是一些生成模型搞的，因为图片特征很明显，有些地方特别模糊，然后生成的其实很没有逻辑。最开始以为是 GPT-3 的应用，就把图片描述转成文字，后来觉得不合理，因为太缺乏想象力了，而且各个元素的分布其实也特别明显，都是直直的，很不自然。应该是一些从语义图片生成原始图片的工作，例如 NVIDIA 的一些艺术创作。\n做之前我没想到过 NVIDIA 的那些 GAN 居然可以用到验证码领域，也没想到他升级之后从原来的目标检测降维到了只需要图像处理就能通过。\n正文 @QIN2DIM 之前就写过一个 hCaptcha-challenger 的项目利用 YOLOv5 来搞定，在更新后 release 了一个数据集 vertical_river，于是我用图像处理光速实现了一个 Demo。\n首先这个图像特征很明显，主要就是有几个元素：后面的天空、山、草地、水，又是非常明显的划分和分布，都是一块一块的。\n最一开始的思路是，先来几个滤波，比如 高斯滤波 ，然后直接用 slic 进行超像素分割，期望的结果是，超像素能够把每个色块全部归成一个超像素。最后结果其实不是很理想，因为超像素的划分很大程度上不是特别依赖颜色，而且如果限制了超像素数量就会让一些更大颜色范围的聚成一类。下面是一个例子。\n其实是可以看出来很多问题的，有些该划分的部分并没有得到正确的划分，反而聚成了一类，有些不该划分的地方，反而因为滤波的作用让他们聚成了一类。\n最后反复调整参数无果，感觉这种划分方式不应该采用一个超像素作为一个色块，而是以超像素的划分结果作为参考或者划分边界来进行划分。\n本来想尝试一些边缘增强的算法，但是也没有找到合适的，因为观察到验证码的图片大多边界非常模糊，所以在划分的时候保留边缘信息是十分重要的。所以在选取滤波的时候，就得特别重视这个滤波是否能正确的保存边缘信息，而不是让边缘模糊，其中 双边滤波 就是一个很好的选择，除此之外，均值偏移也是一个不错的选择。\n经过这两步，你已经变得 近视 了，但是边缘还比较清晰，你现在可以做色块划分了。这里主要用了 scikit-image.graph.rag_mean_color 来获取平均色块，主要参考了官方的 RAG Merge 的实现。\n判断条件就写的比较简单了，我只判断了最后一行是否存在 3 个色块及以上，如果存在那就认为中间是有被河流分开，存在垂直河流。感觉这个判断条件还是可以优化一下的，不过经过测试，大概 100 张图片也就错 2 张图片左右，即使不优化这个正确率其实也是可以接受的。\n最后效果是这样的：\n发了一个 pr，被 @QIN2DIM merge 以后的效果如下：\n测试 + 可视化用到的 Code：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 #!/usr/bin/env python # -*- coding: utf-8 -*- # @File : src\\services\\hcaptcha_challenger\\river_challenger.py # @Time : 2022-03-01 20:32:08 # @Author : Bingjie Yan # @Email : bj.yan.pa@qq.com # @License : Apache License 2.0 import cv2 import numpy as np import skimage from skimage.morphology import disk from skimage.segmentation import watershed, slic, mark_boundaries from skimage.filters import rank from skimage.util import img_as_ubyte from skimage.color import rgb2gray, label2rgb from skimage.future import graph from scipy import ndimage as ndi import matplotlib.pyplot as plt def _weight_mean_color(graph, src, dst, n): \"\"\"Callback to handle merging nodes by recomputing mean color. The method expects that the mean color of `dst` is already computed. Parameters ---------- graph : RAG The graph under consideration. src, dst : int The vertices in `graph` to be merged. n : int A neighbor of `src` or `dst` or both. Returns ------- data : dict A dictionary with the `\"weight\"` attribute set as the absolute difference of the mean color between node `dst` and `n`. \"\"\" diff = graph.nodes[dst]['mean color'] - graph.nodes[n]['mean color'] diff = np.linalg.norm(diff) return {'weight': diff} def merge_mean_color(graph, src, dst): \"\"\"Callback called before merging two nodes of a mean color distance graph. This method computes the mean color of `dst`. Parameters ---------- graph : RAG The graph under consideration. src, dst : int The vertices in `graph` to be merged. \"\"\" graph.nodes[dst]['total color'] += graph.nodes[src]['total color'] graph.nodes[dst]['pixel count'] += graph.nodes[src]['pixel count'] graph.nodes[dst]['mean color'] = (graph.nodes[dst]['total color'] / graph.nodes[dst]['pixel count']) class RiverChallenger(object): def __init__(self) -\u003e None: pass def challenge(self, img_stream): img_arr = np.frombuffer(img_stream, np.uint8) img = cv2.imdecode(img_arr, flags=1) height, width = img.shape[:2] # # filter img = cv2.pyrMeanShiftFiltering(img, sp=10, sr=40) img = cv2.bilateralFilter(img, d=9, sigmaColor=100, sigmaSpace=75) # # enhance brightness # img_hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV) # img_hsv[:, :, 2] = img_hsv[:, :, 2] * 1.2 # img = cv2.cvtColor(img_hsv, cv2.COLOR_HSV2BGR) labels = slic(img, compactness=30, n_segments=400, start_label=1) g = graph.rag_mean_color(img, labels) labels2 = graph.merge_hierarchical(labels, g, thresh=35, rag_copy=False, in_place_merge=True, merge_func=merge_mean_color, weight_func=_weight_mean_color) # view results out = label2rgb(labels2, img, kind='avg', bg_label=0) out = mark_boundaries(out, labels2, (0, 0, 0)) skimage.io.imshow(out) skimage.io.show() print(np.unique(labels2[-1])) ref_value = len(np.unique(labels2[-1])) return ref_value \u003e= 3 if __name__ == '__main__': import os import sys sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))) # result_path = 'result.txt' # if os.path.exists(result_path): # os.remove(result_path) # result_file = open(result_path, 'w') result_file = sys.stdout base_path = os.path.join('database', '_challenge') list_dirs = os.listdir(base_path) for dir in list_dirs[:1]: print(dir, file=result_file) for i in range(1, 10): img_filepath = os.path.join(base_path, dir, f'挑战图片{i}.png') with open(img_filepath, \"rb\") as file: data = file.read() rc = RiverChallenger() result = rc.challenge(data) print(f'挑战图片{i}.png:{result}', file=result_file) 结语 神经网络让一切变得复杂了，又让一切变得简单了。\n（论 hCaptcha 工程师看到自己开发半天的项目被不到一夜之间用了更简单的算法突破了是什么体验？）\n","wordCount":"1703","inLanguage":"zh-cn","datePublished":"2022-03-02T10:32:15+08:00","dateModified":"2023-03-21T12:52:17+08:00","author":{"@type":"Person","name":"北屿"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.bj-yan.top/p/blog-hcaptcha-vertical-river/"},"publisher":{"@type":"Organization","name":"小冰爱吃盐","logo":{"@type":"ImageObject","url":"https://blog.bj-yan.top/favicon.jpg"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://blog.bj-yan.top/ accesskey=h title="Home (Alt + H)"><img src=/favicon.jpg alt=logo aria-label=logo height=35>Home</a>
<span class=logo-switches><ul class=lang-switch><li>|</li></ul></span></div><ul id=menu><li><a href=https://blog.bj-yan.top/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.bj-yan.top/post/ title=Posts><span>Posts</span></a></li><li><a href=https://blog.bj-yan.top/archives title=Archive><span>Archive</span></a></li><li><a href=https://blog.bj-yan.top/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://blog.bj-yan.top/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.bj-yan.top/about/ title=About><span>About</span></a></li><li><a href=https://blog.bj-yan.top/friends/ title=Friends><span>Friends</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.bj-yan.top/>Home</a>&nbsp;»&nbsp;<a href=https://blog.bj-yan.top/post/>Posts</a></div><h1 class=post-title>"Please click each image containing a vertical river"</h1><div class=post-meta>March 2, 2022 · Edited March 21, 2023 · 1703 words · 4 min · 北屿&nbsp;|&nbsp;<a href=https://github.com/beiyuouo/blog-source/tree/main/content/post/blog-hcaptcha-vertical-river.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%bc%95%e8%a8%80 aria-label=引言>引言</a></li><li><a href=#%e6%ad%a3%e6%96%87 aria-label=正文>正文</a></li><li><a href=#%e7%bb%93%e8%af%ad aria-label=结语>结语</a></li></ul></div></details></div><div class=post-content><figure><img loading=lazy src=/img/hcaptcha-vertical-river/demo.jpg#center></figure><h2 id=引言>引言<a hidden class=anchor aria-hidden=true href=#引言>#</a></h2><p>最近 <a href=https://www.hcaptcha.com/><code>hCaptcha</code></a> 迎来了一次更新，从之前的物体识别，改成了选出图片中的垂直河流。如上图，截自<a href=https://www.hcaptcha.com/>https://www.hcaptcha.com/</a>。</p><p>说实话，第一看看到就知道是一些生成模型搞的，因为图片特征很明显，有些地方特别模糊，然后生成的其实很没有逻辑。最开始以为是 GPT-3 的应用，就把图片描述转成文字，后来觉得不合理，因为太缺乏想象力了，而且各个元素的分布其实也特别明显，都是直直的，很不自然。应该是一些从语义图片生成原始图片的工作，例如 NVIDIA 的一些艺术创作。</p><p>做之前我没想到过 NVIDIA 的那些 GAN 居然可以用到验证码领域，也没想到他升级之后从原来的目标检测降维到了只需要图像处理就能通过。</p><h2 id=正文>正文<a hidden class=anchor aria-hidden=true href=#正文>#</a></h2><p><a href=https://blog.echosec.top/>@QIN2DIM</a> 之前就写过一个 <a href=https://github.com/QIN2DIM/hcaptcha-challenger><code>hCaptcha-challenger</code></a> 的项目利用 YOLOv5 来搞定，在更新后 release 了一个数据集 <a href=https://github.com/QIN2DIM/img_pool/releases/tag/vertical_river>vertical_river</a>，于是我用图像处理光速实现了一个 Demo。</p><p>首先这个图像特征很明显，主要就是有几个元素：后面的天空、山、草地、水，又是非常明显的划分和分布，都是一块一块的。</p><p>最一开始的思路是，先来几个滤波，比如 <code>高斯滤波</code> ，然后直接用 <code>slic</code> 进行超像素分割，期望的结果是，超像素能够把每个色块全部归成一个超像素。最后结果其实不是很理想，因为超像素的划分很大程度上不是特别依赖颜色，而且如果限制了超像素数量就会让一些更大颜色范围的聚成一类。下面是一个例子。</p><figure><img loading=lazy src=/img/hcaptcha-vertical-river/slic-demo.jpg#center></figure><p>其实是可以看出来很多问题的，有些该划分的部分并没有得到正确的划分，反而聚成了一类，有些不该划分的地方，反而因为滤波的作用让他们聚成了一类。</p><p>最后反复调整参数无果，感觉这种划分方式不应该采用一个超像素作为一个色块，而是以超像素的划分结果作为参考或者划分边界来进行划分。</p><p>本来想尝试一些边缘增强的算法，但是也没有找到合适的，因为观察到验证码的图片大多边界非常模糊，所以在划分的时候保留边缘信息是十分重要的。所以在选取滤波的时候，就得特别重视这个滤波是否能正确的保存边缘信息，而不是让边缘模糊，其中 <code>双边滤波</code> 就是一个很好的选择，除此之外，<code>均值偏移</code>也是一个不错的选择。</p><p>经过这两步，你已经变得 <strong>近视</strong> 了，但是边缘还比较清晰，你现在可以做色块划分了。这里主要用了 <code>scikit-image.graph.rag_mean_color</code> 来获取平均色块，主要参考了官方的 <a href=https://scikit-image.org/docs/stable/auto_examples/segmentation/plot_rag_merge.html#sphx-glr-auto-examples-segmentation-plot-rag-merge-py><code>RAG Merge</code></a> 的实现。</p><p>判断条件就写的比较简单了，我只判断了最后一行是否存在 3 个色块及以上，如果存在那就认为中间是有被河流分开，存在垂直河流。感觉这个判断条件还是可以优化一下的，不过经过测试，大概 100 张图片也就错 2 张图片左右，即使不优化这个正确率其实也是可以接受的。</p><p>最后效果是这样的：</p><p><figure><img loading=lazy src=/img/hcaptcha-vertical-river/rag-demo1.jpg#center></figure><figure><img loading=lazy src=/img/hcaptcha-vertical-river/rag-pic1.png#center></figure></p><p><figure><img loading=lazy src=/img/hcaptcha-vertical-river/rag-demo2.jpg#center></figure><figure><img loading=lazy src=/img/hcaptcha-vertical-river/rag-pic2.png#center></figure></p><p>发了一个 pr，被 <a href=https://blog.echosec.top/>@QIN2DIM</a> merge 以后的效果如下：</p><figure><img loading=lazy src=/img/hcaptcha-vertical-river/demo.gif#center></figure><p>测试 + 可视化用到的 Code：</p><div class=highlight><div style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#686868">131
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#999;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># -*- coding: utf-8 -*-</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># @File    :   src\services\hcaptcha_challenger\river_challenger.py</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># @Time    :   2022-03-01 20:32:08</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># @Author  :   Bingjie Yan</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># @Email   :   bj.yan.pa@qq.com</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># @License :   Apache License 2.0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>import</span> <span style=color:#447fcf;text-decoration:underline>cv2</span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>import</span> <span style=color:#447fcf;text-decoration:underline>numpy</span> <span style=color:#6ab825;font-weight:700>as</span> <span style=color:#447fcf;text-decoration:underline>np</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>import</span> <span style=color:#447fcf;text-decoration:underline>skimage</span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>from</span> <span style=color:#447fcf;text-decoration:underline>skimage.morphology</span> <span style=color:#6ab825;font-weight:700>import</span> disk
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>from</span> <span style=color:#447fcf;text-decoration:underline>skimage.segmentation</span> <span style=color:#6ab825;font-weight:700>import</span> watershed, slic, mark_boundaries
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>from</span> <span style=color:#447fcf;text-decoration:underline>skimage.filters</span> <span style=color:#6ab825;font-weight:700>import</span> rank
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>from</span> <span style=color:#447fcf;text-decoration:underline>skimage.util</span> <span style=color:#6ab825;font-weight:700>import</span> img_as_ubyte
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>from</span> <span style=color:#447fcf;text-decoration:underline>skimage.color</span> <span style=color:#6ab825;font-weight:700>import</span> rgb2gray, label2rgb
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>from</span> <span style=color:#447fcf;text-decoration:underline>skimage.future</span> <span style=color:#6ab825;font-weight:700>import</span> graph
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>from</span> <span style=color:#447fcf;text-decoration:underline>scipy</span> <span style=color:#6ab825;font-weight:700>import</span> ndimage <span style=color:#6ab825;font-weight:700>as</span> ndi
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>import</span> <span style=color:#447fcf;text-decoration:underline>matplotlib.pyplot</span> <span style=color:#6ab825;font-weight:700>as</span> <span style=color:#447fcf;text-decoration:underline>plt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>def</span> <span style=color:#447fcf>_weight_mean_color</span>(graph, src, dst, n):
</span></span><span style=display:flex><span>    <span style=color:#ed9d13>&#34;&#34;&#34;Callback to handle merging nodes by recomputing mean color.
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    The method expects that the mean color of `dst` is already computed.
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    Parameters
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    ----------
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    graph : RAG
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>        The graph under consideration.
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    src, dst : int
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>        The vertices in `graph` to be merged.
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    n : int
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>        A neighbor of `src` or `dst` or both.
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    Returns
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    -------
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    data : dict
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>        A dictionary with the `&#34;weight&#34;` attribute set as the absolute
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>        difference of the mean color between node `dst` and `n`.
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    diff = graph.nodes[dst][<span style=color:#ed9d13>&#39;mean color&#39;</span>] - graph.nodes[n][<span style=color:#ed9d13>&#39;mean color&#39;</span>]
</span></span><span style=display:flex><span>    diff = np.linalg.norm(diff)
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>return</span> {<span style=color:#ed9d13>&#39;weight&#39;</span>: diff}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>def</span> <span style=color:#447fcf>merge_mean_color</span>(graph, src, dst):
</span></span><span style=display:flex><span>    <span style=color:#ed9d13>&#34;&#34;&#34;Callback called before merging two nodes of a mean color distance graph.
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    This method computes the mean color of `dst`.
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    Parameters
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    ----------
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    graph : RAG
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>        The graph under consideration.
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    src, dst : int
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>        The vertices in `graph` to be merged.
</span></span></span><span style=display:flex><span><span style=color:#ed9d13>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    graph.nodes[dst][<span style=color:#ed9d13>&#39;total color&#39;</span>] += graph.nodes[src][<span style=color:#ed9d13>&#39;total color&#39;</span>]
</span></span><span style=display:flex><span>    graph.nodes[dst][<span style=color:#ed9d13>&#39;pixel count&#39;</span>] += graph.nodes[src][<span style=color:#ed9d13>&#39;pixel count&#39;</span>]
</span></span><span style=display:flex><span>    graph.nodes[dst][<span style=color:#ed9d13>&#39;mean color&#39;</span>] = (graph.nodes[dst][<span style=color:#ed9d13>&#39;total color&#39;</span>] /
</span></span><span style=display:flex><span>                                      graph.nodes[dst][<span style=color:#ed9d13>&#39;pixel count&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>class</span> <span style=color:#447fcf;text-decoration:underline>RiverChallenger</span>(<span style=color:#24909d>object</span>):
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>def</span> __init__(self) -&gt; <span style=color:#6ab825;font-weight:700>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>def</span> <span style=color:#447fcf>challenge</span>(self, img_stream):
</span></span><span style=display:flex><span>        img_arr = np.frombuffer(img_stream, np.uint8)
</span></span><span style=display:flex><span>        img = cv2.imdecode(img_arr, flags=<span style=color:#3677a9>1</span>)
</span></span><span style=display:flex><span>        height, width = img.shape[:<span style=color:#3677a9>2</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#999;font-style:italic># # filter</span>
</span></span><span style=display:flex><span>        img = cv2.pyrMeanShiftFiltering(img, sp=<span style=color:#3677a9>10</span>, sr=<span style=color:#3677a9>40</span>)
</span></span><span style=display:flex><span>        img = cv2.bilateralFilter(img, d=<span style=color:#3677a9>9</span>, sigmaColor=<span style=color:#3677a9>100</span>, sigmaSpace=<span style=color:#3677a9>75</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#999;font-style:italic># # enhance brightness</span>
</span></span><span style=display:flex><span>        <span style=color:#999;font-style:italic># img_hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)</span>
</span></span><span style=display:flex><span>        <span style=color:#999;font-style:italic># img_hsv[:, :, 2] = img_hsv[:, :, 2] * 1.2</span>
</span></span><span style=display:flex><span>        <span style=color:#999;font-style:italic># img = cv2.cvtColor(img_hsv, cv2.COLOR_HSV2BGR)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        labels = slic(img, compactness=<span style=color:#3677a9>30</span>, n_segments=<span style=color:#3677a9>400</span>, start_label=<span style=color:#3677a9>1</span>)
</span></span><span style=display:flex><span>        g = graph.rag_mean_color(img, labels)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        labels2 = graph.merge_hierarchical(labels,
</span></span><span style=display:flex><span>                                           g,
</span></span><span style=display:flex><span>                                           thresh=<span style=color:#3677a9>35</span>,
</span></span><span style=display:flex><span>                                           rag_copy=<span style=color:#6ab825;font-weight:700>False</span>,
</span></span><span style=display:flex><span>                                           in_place_merge=<span style=color:#6ab825;font-weight:700>True</span>,
</span></span><span style=display:flex><span>                                           merge_func=merge_mean_color,
</span></span><span style=display:flex><span>                                           weight_func=_weight_mean_color)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#999;font-style:italic># view results</span>
</span></span><span style=display:flex><span>        out = label2rgb(labels2, img, kind=<span style=color:#ed9d13>&#39;avg&#39;</span>, bg_label=<span style=color:#3677a9>0</span>)
</span></span><span style=display:flex><span>        out = mark_boundaries(out, labels2, (<span style=color:#3677a9>0</span>, <span style=color:#3677a9>0</span>, <span style=color:#3677a9>0</span>))
</span></span><span style=display:flex><span>        skimage.io.imshow(out)
</span></span><span style=display:flex><span>        skimage.io.show()
</span></span><span style=display:flex><span>        <span style=color:#24909d>print</span>(np.unique(labels2[-<span style=color:#3677a9>1</span>]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ref_value = <span style=color:#24909d>len</span>(np.unique(labels2[-<span style=color:#3677a9>1</span>]))
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>return</span> ref_value &gt;= <span style=color:#3677a9>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6ab825;font-weight:700>if</span> __name__ == <span style=color:#ed9d13>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>import</span> <span style=color:#447fcf;text-decoration:underline>os</span>
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>import</span> <span style=color:#447fcf;text-decoration:underline>sys</span>
</span></span><span style=display:flex><span>    sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#999;font-style:italic># result_path = &#39;result.txt&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#999;font-style:italic># if os.path.exists(result_path):</span>
</span></span><span style=display:flex><span>    <span style=color:#999;font-style:italic>#     os.remove(result_path)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#999;font-style:italic># result_file = open(result_path, &#39;w&#39;)</span>
</span></span><span style=display:flex><span>    result_file = sys.stdout
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    base_path = os.path.join(<span style=color:#ed9d13>&#39;database&#39;</span>, <span style=color:#ed9d13>&#39;_challenge&#39;</span>)
</span></span><span style=display:flex><span>    list_dirs = os.listdir(base_path)
</span></span><span style=display:flex><span>    <span style=color:#6ab825;font-weight:700>for</span> <span style=color:#24909d>dir</span> <span style=color:#6ab825;font-weight:700>in</span> list_dirs[:<span style=color:#3677a9>1</span>]:
</span></span><span style=display:flex><span>        <span style=color:#24909d>print</span>(<span style=color:#24909d>dir</span>, file=result_file)
</span></span><span style=display:flex><span>        <span style=color:#6ab825;font-weight:700>for</span> i <span style=color:#6ab825;font-weight:700>in</span> <span style=color:#24909d>range</span>(<span style=color:#3677a9>1</span>, <span style=color:#3677a9>10</span>):
</span></span><span style=display:flex><span>            img_filepath = os.path.join(base_path, <span style=color:#24909d>dir</span>, <span style=color:#ed9d13>f</span><span style=color:#ed9d13>&#39;挑战图片</span><span style=color:#ed9d13>{</span>i<span style=color:#ed9d13>}</span><span style=color:#ed9d13>.png&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6ab825;font-weight:700>with</span> <span style=color:#24909d>open</span>(img_filepath, <span style=color:#ed9d13>&#34;rb&#34;</span>) <span style=color:#6ab825;font-weight:700>as</span> file:
</span></span><span style=display:flex><span>                data = file.read()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            rc = RiverChallenger()
</span></span><span style=display:flex><span>            result = rc.challenge(data)
</span></span><span style=display:flex><span>            <span style=color:#24909d>print</span>(<span style=color:#ed9d13>f</span><span style=color:#ed9d13>&#39;挑战图片</span><span style=color:#ed9d13>{</span>i<span style=color:#ed9d13>}</span><span style=color:#ed9d13>.png:</span><span style=color:#ed9d13>{</span>result<span style=color:#ed9d13>}</span><span style=color:#ed9d13>&#39;</span>, file=result_file)
</span></span></code></pre></td></tr></table></div></div><h2 id=结语>结语<a hidden class=anchor aria-hidden=true href=#结语>#</a></h2><p>神经网络让一切变得复杂了，又让一切变得简单了。</p><p>（论 <code>hCaptcha</code> 工程师看到自己开发半天的项目被不到一夜之间用了更简单的算法突破了是什么体验？）</p></div><footer class=post-footer><div class=post-copyright-div><ul class=post-copyright><div class=post-copyright-title><p>"Please click each image containing a vertical river"</p><p><a href=https://blog.bj-yan.top/p/blog-hcaptcha-vertical-river/>https://blog.bj-yan.top/p/blog-hcaptcha-vertical-river/</a></p></div><div class="post-copy-meta level is-mobile"><div class=level-left><div class="level-item is-narrow"><div><h6>作者</h6><p>北屿</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>March 2, 2022</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>March 21, 2023</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class=icons rel=noopener target=_blank title="Creative Commons" href=https://creativecommons.org/><i class="icon fab fa-creative-commons"></i></a>
<a class=icons rel=noopener target=_blank title=Attribution href=https://creativecommons.org/licenses/by/4.0/><i class="icon fab fa-creative-commons-by"></i></a>
<a class=icons rel=noopener target=_blank title=Noncommercial href=https://creativecommons.org/licenses/by-nc/4.0/><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></ul></div><ul class=post-tags><li><a href=https://blog.bj-yan.top/tags/hcaptcha/>Hcaptcha</a></li><li><a href=https://blog.bj-yan.top/tags/gan/>GAN</a></li><li><a href=https://blog.bj-yan.top/tags/blog/>Blog</a></li><li><a href=https://blog.bj-yan.top/tags/captcha/>Captcha</a></li><li><a href=https://blog.bj-yan.top/tags/deep-learning/>Deep-Learning</a></li></ul><nav class=paginav><a class=prev href=https://blog.bj-yan.top/p/blog-hcaptcha-sky-left-airplane/><span class=title>«</span><br><span>"Please click each image containing an airplane in the sky flying left"</span>
</a><a class=next href=https://blog.bj-yan.top/p/blog-github-actions-cv/><span class=title>»</span><br><span>GitHub Actions 进行简历编译与分发的最佳实践</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label='share "Please click each image containing a vertical river" on twitter' href="https://twitter.com/intent/tweet/?text=%22Please%20click%20each%20image%20containing%20a%20vertical%20river%22&amp;url=https%3a%2f%2fblog.bj-yan.top%2fp%2fblog-hcaptcha-vertical-river%2f&amp;hashtags=hcaptcha%2cGAN%2cblog%2ccaptcha%2cdeep-learning"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label='share "Please click each image containing a vertical river" on linkedin' href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.bj-yan.top%2fp%2fblog-hcaptcha-vertical-river%2f&amp;title=%22Please%20click%20each%20image%20containing%20a%20vertical%20river%22&amp;summary=%22Please%20click%20each%20image%20containing%20a%20vertical%20river%22&amp;source=https%3a%2f%2fblog.bj-yan.top%2fp%2fblog-hcaptcha-vertical-river%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label='share "Please click each image containing a vertical river" on reddit' href="https://reddit.com/submit?url=https%3a%2f%2fblog.bj-yan.top%2fp%2fblog-hcaptcha-vertical-river%2f&title=%22Please%20click%20each%20image%20containing%20a%20vertical%20river%22"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label='share "Please click each image containing a vertical river" on facebook' href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.bj-yan.top%2fp%2fblog-hcaptcha-vertical-river%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label='share "Please click each image containing a vertical river" on whatsapp' href="https://api.whatsapp.com/send?text=%22Please%20click%20each%20image%20containing%20a%20vertical%20river%22%20-%20https%3a%2f%2fblog.bj-yan.top%2fp%2fblog-hcaptcha-vertical-river%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label='share "Please click each image containing a vertical river" on telegram' href="https://telegram.me/share/url?text=%22Please%20click%20each%20image%20containing%20a%20vertical%20river%22&amp;url=https%3a%2f%2fblog.bj-yan.top%2fp%2fblog-hcaptcha-vertical-river%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><div class=reward-container><div>Have fun.</div><button onclick='var qr=document.getElementById("qr");qr.style.display=qr.style.display==="none"?"block":"none"'>Donate</button><div id=qr style=display:none><div style=display:inline-block><img src=/donate/alipay.png alt=alipay><p>alipay</p></div><div style=display:inline-block><img src=/donate/wechatpay.png alt=wechatpay><p>wechatpay</p></div></div></div><div class=comments><div id=comment-giscus></div></div><script>var gis,iframes,path="/p/blog-hcaptcha-vertical-river/",path=path.substring(path.indexOf("/")+1),path=decodeURI(path);console.log(path),gis=document.createElement("script"),gis.type="text/javascript",gis.async=!0,gis.setAttribute("src","https://giscus.app/client.js"),gis.setAttribute("data-repo","beiyuouo/blog-comment"),gis.setAttribute("data-repo-id","R_kgDOGF_a6w"),gis.setAttribute("data-category","General"),gis.setAttribute("data-category-id","DIC_kwDOGF_a684B_YGN"),gis.setAttribute("data-mapping","pathname"),gis.setAttribute("data-strict",0),gis.setAttribute("data-reactions-enabled","1"),gis.setAttribute("data-emit-metadata","0"),gis.setAttribute("data-input-position","top"),gis.setAttribute("data-theme","transparent_dark"),gis.setAttribute("data-lang","en"),gis.setAttribute("data-loading","lazy"),gis.setAttribute("crossorigin","anonymous"),iframes=document.getElementsByTagName("iframe"),document.getElementById("comment-giscus").appendChild(gis)</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.bj-yan.top/>小冰爱吃盐</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span><br><span id=busuanzi_container_page_pv>本文总阅读量<span id=busuanzi_value_page_pv></span>次
</span><span id=busuanzi_container_site_pv>本站总访问量<span id=busuanzi_value_site_pv></span>次
</span><span id=busuanzi_container_site_uv>本站访客数<span id=busuanzi_value_site_uv></span>人次
</span><script type=text/javascript id=mapmyvisitors src="//mapmyvisitors.com/map.js?d=Y4m14m4Jh2bS4Vyr_FP_8YF3q3_awg-YnkQxkAdOtIw&cl=ffffff&w=200"></script></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>